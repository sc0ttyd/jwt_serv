<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Demo Auth App</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
</head>
<body>
<div class="container-fluid">
    <button id="twitterLogin" onclick="login()" class="btn btn-primary btn-lg" type="submit">Login via Twitter</button>
    <input class="form-control" id="status" type="text" disabled>
</div>

<script>
    var login = function() {
        $('#twitterLogin').addClass('btn-disabled');
        $('#status').val('Requesting token...');

        $.getJSON('/auth/twitter', function(data) {
            if (data.success) {
                if (data.result === 'redirect') {
                    window.open(data.url, 'twitter_login', "width=800,height=400,resizable,scrollbars=yes,status=1");
                    $('#status').val('Awaiting successful redirect...');
                    $('#twitterLogin').removeClass('btn-disabled');
                }
            }
        });
    };

    window.addEventListener('message', function(event) {
        if (event.origin !== window.location.origin) {
            $('#status').val('ERROR: bad postMessage origin, ' + event.origin);
        } else {
            if (event.data !== 'authTokenSet') {
                $('#status').val('ERROR: Unknown postMessage: ' + event.data);
            } else {
                $('#status').val('Login successful.');
            }
        }
    }, false);
</script>
</body>
</html>
